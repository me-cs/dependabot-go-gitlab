go-dependency-upgrade:
  stage: lint
  tags:
    - your_tags
  rules:
    - if: '$AUTO_UPGRADE == "true" && $CI_COMMIT_REF_NAME == "master"'
  script:
    # è®¾ç½®ä¸¥æ ¼æ¨¡å¼ï¼Œä»»ä½•é”™è¯¯éƒ½ä¼šå¯¼è‡´è„šæœ¬ç»ˆæ­¢
    - set -e
    - set -o pipefail
    - set -u  # æ£€æŸ¥æœªå®šä¹‰çš„å˜é‡

    # å®šä¹‰å…¨å±€å˜é‡
    - WORK_DIR="$CI_PROJECT_DIR/../go_mod_upgrade_work"
    - DATE=$(date +%Y%m%d)
    - BRANCH="go-mod-upgrade-$DATE"
    - REPO_URL="your_repo_url"

    # å®šä¹‰æ—¥å¿—å‡½æ•°ï¼Œç»Ÿä¸€æ—¥å¿—æ ¼å¼
    - |
      log_info() {
        echo "ğŸ”µ [INFO] $1"
      }
      
      log_warn() {
        echo "âš ï¸ [WARN] $1"
      }
      
      log_error() {
        echo "ğŸ”´ [ERROR] $1"
      }
      
      log_success() {
        echo "âœ… [SUCCESS] $1"
      }

    # å®šä¹‰æ¸…ç†å‡½æ•°ï¼Œç¡®ä¿ç¯å¢ƒå§‹ç»ˆå¹²å‡€ï¼ˆç®€åŒ–ç‰ˆï¼‰
    - |
      cleanup() {
        log_info "å¼€å§‹æ¸…ç†å·¥ä½œç¯å¢ƒ..."
        rm -rf "$WORK_DIR"
        log_success "å·¥ä½œç›®å½•æ¸…ç†å®Œæˆ"
      }
      
      # æ³¨å†Œæ¸…ç†å‡½æ•°ï¼Œç¡®ä¿è„šæœ¬é€€å‡ºæ—¶æ‰§è¡Œ
      trap cleanup EXIT

    # æ£€æŸ¥æ˜¯å¦ä¸ºå·¥ä½œæ—¥
    - |
      log_info "æ£€æŸ¥æ˜¯å¦ä¸ºå·¥ä½œæ—¥..."
      current_date=$(date +%Y-%m-%d)
      workday=$(curl -s -A "Mozilla/5.0" --max-time 10 --connect-timeout 5 "http://timor.tech/api/holiday/info/${current_date}" | jq -r '.type.type' 2>/dev/null || echo "error")
      
      if [[ "$workday" == "error" || -z "$workday" || "$workday" == "null" ]]; then
        log_warn "å·¥ä½œæ—¥APIè¯·æ±‚å¤±è´¥ï¼Œé»˜è®¤æŒ‰å·¥ä½œæ—¥å¤„ç†"
      elif [[ "$workday" =~ ^[12]$ ]]; then
        log_info "éå·¥ä½œæ—¥ï¼ˆ${current_date}ï¼‰ï¼Œè·³è¿‡æ‰§è¡Œ"
        exit 0
      else
        log_success "å·¥ä½œæ—¥ï¼ˆ${current_date}ï¼‰ï¼Œç»§ç»­æ‰§è¡Œä¾èµ–å‡çº§"
      fi

    # åˆå§‹åŒ–å·¥ä½œç›®å½•
    - |
      log_info "åˆå§‹åŒ–å…¨æ–°å·¥ä½œç›®å½•..."
      rm -rf "$WORK_DIR"
      mkdir -p "$WORK_DIR"
      cd "$WORK_DIR"
      
      # å…‹éš†ä»“åº“ï¼ˆä½¿ç”¨å¹²å‡€çš„å…‹éš†ï¼Œé¿å…å†å²é—®é¢˜ï¼‰
      log_info "å…‹éš†é¡¹ç›®ä»“åº“..."
      git clone --depth 1 "$REPO_URL" background
      cd background
      
      # éªŒè¯å½“å‰åˆ†æ”¯
      current_branch=$(git branch --show-current)
      log_info "å½“å‰åˆ†æ”¯: $current_branch"
      
      # ç¡®ä¿åœ¨masteråˆ†æ”¯ä¸Š
      if [ "$current_branch" != "master" ]; then
        log_info "åˆ‡æ¢åˆ°masteråˆ†æ”¯..."
        git checkout master || git checkout -b master origin/master
      fi
      log_success "å·²åœ¨masteråˆ†æ”¯"

    # æ£€æŸ¥å¹¶æ›´æ–°go-mod-upgradeå·¥å…·
    - |
      log_info "æ£€æŸ¥go-mod-upgradeå·¥å…·..."
      if ! command -v go-mod-upgrade &> /dev/null; then
        log_info "å®‰è£…go-mod-upgrade..."
        go install github.com/oligot/go-mod-upgrade@latest
      else
        CURRENT_VERSION=$(go-mod-upgrade --version 2>&1 | grep -oP 'v\d+\.\d+\.\d+')
        LATEST_VERSION=$(curl -s --max-time 10 --connect-timeout 5 https://api.github.com/repos/oligot/go-mod-upgrade/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
      
        log_info "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
        log_info "æœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION"
      
        if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
          log_info "å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬..."
          go install github.com/oligot/go-mod-upgrade@latest
        else
          log_success "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
        fi
      fi

    # æ‰§è¡Œä¾èµ–å‡çº§ï¼ˆç®€åŒ–åˆ†æ”¯ç®¡ç†ï¼‰
    - |
      log_info "æ‰§è¡Œä¾èµ–å‡çº§..."
      
      # è®°å½•å½“å‰ä¾èµ–çŠ¶æ€
      go list -m -f '{{if not .Indirect}}{{.Path}}@{{.Version}}{{end}}' all > current_deps.txt
      
      # å‡çº§ä¾èµ–
      log_info "è¿è¡Œgo-mod-upgrade..."
      go-mod-upgrade --ignore ignore_repo \
                     -f
      
      # æ•´ç†ä¾èµ–
      go mod tidy
      
      # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜æ›´
      if [[ $(git status --porcelain go.mod go.sum) ]]; then
        log_info "æ£€æµ‹åˆ°go.mod/go.sumå˜æ›´ï¼Œç»§ç»­å¤„ç†..."
      
        # åˆ›å»ºæ–°åˆ†æ”¯ï¼ˆå…¨æ–°ç¯å¢ƒä¸­æ— éœ€åˆ é™¤æ—§åˆ†æ”¯ï¼‰
        log_info "åˆ›å»ºæ–°åˆ†æ”¯ $BRANCH..."
        git checkout -b "$BRANCH"
        log_success "å·²åˆ›å»ºæ–°åˆ†æ”¯ $BRANCH"
      
        # è·å–å‡çº§åçš„ä¾èµ–åˆ—è¡¨
        go list -m -f '{{if not .Indirect}}{{.Path}}@{{.Version}}{{end}}' all > upgraded_deps.txt
      
        # æ£€æŸ¥æ˜¯å¦æœ‰ç›´æ¥ä¾èµ–å‡çº§
        if diff -q current_deps.txt upgraded_deps.txt > /dev/null; then
          log_success "ç›´æ¥ä¾èµ–æ²¡æœ‰å˜æ›´ï¼Œä»…é—´æ¥ä¾èµ–å‡çº§ï¼Œæ— éœ€åˆ›å»ºMR"
          exit 0
        fi
      
        # è·å–å‡çº§çš„ç›´æ¥ä¾èµ–æ¨¡å—
        DIRECT_UPGRADED_MODULES=""
        while read -r line; do
          module=$(echo "$line" | cut -d'@' -f1)
          old_version=$(echo "$line" | cut -d'@' -f2)
          new_version=$(grep "^$module@" upgraded_deps.txt | cut -d'@' -f2)
      
          if [ "$old_version" != "$new_version" ]; then
            DIRECT_UPGRADED_MODULES="$DIRECT_UPGRADED_MODULES $module"
          fi
        done < current_deps.txt
      
        # ç”Ÿæˆå˜æ›´æŠ¥å‘Šï¼ˆç®€åŒ–ç½‘ç»œè¯·æ±‚ï¼‰
        log_info "ç”Ÿæˆå‡çº§æŠ¥å‘Š..."
        echo -e "# Goä¾èµ–è‡ªåŠ¨å‡çº§æŠ¥å‘Š ($DATE)\n\nå‡çº§çš„ä¾èµ–åº“åŠå˜æ›´è¯´æ˜ï¼š" > upgrade_report.md
      
        # ä¸ºæ¯ä¸ªç›´æ¥å‡çº§çš„åº“è·å–release notesï¼ˆä¼˜åŒ–è¶…æ—¶ï¼‰
        for module in $DIRECT_UPGRADED_MODULES; do
          echo -e "\n## \`$module\`" >> upgrade_report.md
      
          # è§£æGitHubä»“åº“ä¿¡æ¯
          repo_path=$(echo "$module" | cut -d'/' -f2,3)
          repo_owner=$(echo "$repo_path" | cut -d'/' -f1)
          repo_name=$(echo "$repo_path" | cut -d'/' -f2)
      
          # è·å–æ¨¡å—ç‰ˆæœ¬
          current_version=$(grep "^$module@" current_deps.txt | cut -d'@' -f2)
          new_version=$(grep "^$module@" upgraded_deps.txt | cut -d'@' -f2)
          if [[ ! "$new_version" =~ ^v ]]; then new_version="v$new_version"; fi
      
          log_info "è·å– $module $current_version -> $new_version çš„å˜æ›´..."
      
          # ç®€åŒ–çš„è·å–é€»è¾‘ï¼ˆå•æ¬¡è¯·æ±‚ï¼Œå¸¦è¶…æ—¶ï¼‰
          fetch_with_timeout() {
            local url=$1
            local timeout=5
            curl -s -H "User-Agent: go-dependency-upgrade" --max-time "$timeout" "$url" 2>/dev/null
          }
      
          # è·å–release notes
          api_url="https://api.github.com/repos/$repo_owner/$repo_name/releases/tags/$new_version"
          release_notes=$(fetch_with_timeout "$api_url" | jq -r '.body')
      
          if [ -n "$release_notes" ] && [ "$release_notes" != "null" ]; then
            echo "$release_notes" >> upgrade_report.md
            log_success "è·å–åˆ°å‘å¸ƒè¯´æ˜"
          else
            echo "  - âš ï¸ æœªæ‰¾åˆ°å‘å¸ƒè¯´æ˜" >> upgrade_report.md
            log_warn "æœªæ‰¾åˆ° $module çš„å‘å¸ƒè¯´æ˜"
          fi
        done
      
        # æäº¤å˜æ›´
        log_info "æäº¤å˜æ›´..."
        git add go.mod go.sum
        git commit -m "chore: è‡ªåŠ¨å‡çº§go.mod go.sum"
      
        # æ¨é€åˆ†æ”¯ï¼ˆå…¨æ–°ç¯å¢ƒä¸­æ— éœ€å¤„ç†æ—§åˆ†æ”¯ï¼‰
        log_info "æ¨é€åˆ†æ”¯åˆ°è¿œç¨‹..."
        git push origin "$BRANCH"
      
        # åˆ›å»ºMerge Request
        log_info "åˆ›å»ºåˆå¹¶è¯·æ±‚..."
        MR_DESC=$(cat upgrade_report.md)
        MR_RESPONSE=$(curl --request POST \
          --url "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests" \
          --header "PRIVATE-TOKEN: token" \
          --form "source_branch=$BRANCH" \
          --form "target_branch=master" \
          --form "title=Auto Dependency Upgrade: $DATE" \
          --form "description=$MR_DESC")
      
        # è·å–MRé“¾æ¥
        MR_IID=$(echo "$MR_RESPONSE" | jq -r '.iid')
        MR_URL="$CI_PROJECT_URL/merge_requests/$MR_IID"
        log_success "ä¾èµ–å‡çº§å®Œæˆï¼ŒMRå·²åˆ›å»º: $MR_URL"
      
        # å‘é€é€šçŸ¥
        curl -X POST "notify_addr" \
          -d "ğŸš€ ä¾èµ–å‡çº§å®Œæˆï¼ŒMR: $MR_URL"
      else
        log_success "go.mod/go.sum æ²¡æœ‰å˜æ›´ï¼Œæ— éœ€å‡çº§"
      fi
